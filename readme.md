# An attempted "proper" ephemeral GitHub self-hosted runner

GitHub allows for self-hosted runners to be deployed, however one of the drawbacks has been the fact that after a build there is the potential for leftovers to be present.

This recipe wraps the GitHub `actions/runner` into a container that launches the runner inside a QEMU-based VM, executing a single job then terminating.
This VM is then repeatedly launched in a loop, so that each job is executed on a brand new VM instance.
Internally, the VM downloads a copy of the `actions/runner` binaries on startup, registers itself as an ephemeral self-hosted runner, and waits for a job.

This was hacked together in a couple of afternoons, so be prepared for things to fail.

Organisation-level runners are not yet supported.

## Building the container

```sh
make container
```

This will create a tagged container called `github-runner-vm:latest`.

## Running the container

There are a handful of environment variables that are required in order to actually get the runner talking:

| Environment Variable     | Format                   | Description                                                                                                           |
|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------------------|
| `NUM_CPUS`               | `1`                      | The number of CPUs to assign to the QEMU VM.                                                                          |
| `MEMORY_ALLOC`           | `1024`                   | The number of MB to assign to the QEMU VM.                                                                            |
| `GITHUB_REPOSITORY`      | `owner/repo`             | The repository to attach the self-hosted runners to.                                                                  |
| `GITHUB_TOKEN`           | _As generated by GitHub_ | A fine-grained personal access token, with R/W _Administration_ access to the `GITHUB_REPOSITORY`.                    |
| `http_proxy` (optional)  | `http://squid:3128`      | Proxy to use for any HTTP requests.                                                                                   |
| `https_proxy` (optional) | `http://squid:3128`      | Proxy to use for any HTTPS requests.                                                                                  |
| `no_proxy` (optional)    | `hostA,hostB`            | Hosts to bypass for outbound HTTP[S] requests. Not recommended to be used due to inconsistency between apps using it. |

## docker compose

There is a [docker-compose.yml](docker-compose.yml) which shows how to configure and run the containers.

Note that `runner-proxied` is set to use an internal network, and is wholly reliant on the `squid` proxy to be able to access external systems.

The `runner-direct` container has no such restrictions and can access anything directly.
